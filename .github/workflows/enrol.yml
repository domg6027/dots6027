name: DOTS Enrollment

on:
  workflow_dispatch:
    inputs:
      payload:
        required: true
        type: string

jobs:
  enroll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse payload
        run: |
          echo '${{ inputs.payload }}' > payload.json

      - name: Validate payload
        run: |
          jq -e '.email and .name' payload.json > /dev/null

      - name: Prevent duplicate email enrollment
        run: |
          EMAIL=$(jq -r '.email' payload.json)

          COUNT=$(jq --arg email "$EMAIL" '
            map(select(.email | ascii_downcase == ($email | ascii_downcase))) | length
          ' students.json)

          if [ "$COUNT" -gt 0 ]; then
            echo "âŒ Duplicate enrollment attempt for $EMAIL"
            exit 1
          fi

      - name: Generate confirmation token
        run: |
          TOKEN=$(openssl rand -hex 16)
          echo "$TOKEN" > token.txt

      - name: Append student record
        run: |
          jq --arg token "$(cat token.txt)" '
            . += [{
              email: .email,
              name: .name,
              status: "pending",
              token: $token,
              enrolled_at: now | todate
            }]
          ' payload.json students.json > students.tmp.json

          mv students.tmp.json students.json

      - name: Commit enrollment
        run: |
          git config user.name "dots-bot"
          git config user.email "dots@users.noreply.github.com"
          git add students.json
          git commit -m "Enroll student: $(jq -r .email payload.json)"
          git push
