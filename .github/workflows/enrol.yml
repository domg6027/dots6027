name: DOTS Enrollment Processor

on:
  workflow_dispatch:
    inputs:
      payload:
        description: "Enrollment JSON payload"
        required: true

jobs:
  enroll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse enrollment payload
        id: parse
        run: |
          echo '${{ github.event.inputs.payload }}' > payload.json

      - name: Append student record
        run: |
          node <<'EOF'
          const fs = require('fs');
          const crypto = require('crypto');

          const payload = JSON.parse(fs.readFileSync('payload.json', 'utf8'));
          const data = JSON.parse(fs.readFileSync('students.json', 'utf8'));

          const id = `DOTS-${new Date().getFullYear()}-${String(data.students.length + 1).padStart(4, '0')}`;
          const token = crypto.randomBytes(16).toString('hex');

          const entry = {
            id,
            timestamp: new Date().toISOString(),
            first_name: payload.first_name,
            last_name: payload.last_name,
            email: payload.email,
            country: payload.country,
            status: "pending_email",
            email_verified: false,
            confirmation_token: token,
            source: "enrol.html"
          };

          data.students.push(entry);
          fs.writeFileSync('students.json', JSON.stringify(data, null, 2));
          EOF

      - name: Commit enrollment
        run: |
          git config user.name "DOTS Enrollment Bot"
          git config user.email "bot@users.noreply.github.com"
          git add students.json
          git commit -m "New enrollment (pending email confirmation)"
          git push

      - name: Send confirmation email
        run: |
          node <<'EOF'
          const nodemailer = require("nodemailer");
          const fs = require("fs");

          const data = JSON.parse(fs.readFileSync("students.json", "utf8"));
          const student = data.students[data.students.length - 1];

          const transporter = nodemailer.createTransport({
            host: process.env.SMTP_HOST,
            port: process.env.SMTP_PORT,
            secure: true,
            auth: {
              user: process.env.SMTP_USER,
              pass: process.env.SMTP_PASS
            }
          });

          const link = `https://saphahcentral.github.io/domg6027/confirm.html?token=${student.confirmation_token}`;

          transporter.sendMail({
            from: process.env.MAIL_FROM,
            to: student.email,
            subject: "Confirm your enrollment â€“ Derech Olam Training Services",
            text: `Please confirm your enrollment by clicking the link below:\n\n${link}\n\nIf you did not request this, ignore this email.`
          });
          EOF
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
