name: DOTS Enrollment

on:
  repository_dispatch:
    types: [dots-enroll]

jobs:
  enroll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Save enrollment payload
        run: |
          echo '${{ toJson(github.event.client_payload) }}' > payload.json

      - name: Validate payload
        run: |
          EMAIL=$(jq -r '.email' payload.json)
          if [ -z "$EMAIL" ] || [ "$EMAIL" = "null" ]; then
            echo "âŒ Email missing"
            exit 1
          fi

      - name: Append student to students.json
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ID=$(uuidgen)

          jq --arg id "$ID" \
             --arg ts "$TIMESTAMP" \
             --slurpfile payload payload.json \
             '. + [{
                id: $id,
                first_name: $payload[0].first_name,
                last_name: $payload[0].last_name,
                email: $payload[0].email,
                country: $payload[0].country,
                status: "pending",
                enrolled_at: $ts
              }]' \
             students.json > students.tmp

          mv students.tmp students.json

      - name: Commit updated students.json
        run: |
          git config user.name "DOTS Enrollment Bot"
          git config user.email "derech-olam-6027@outlook.com"
          git add students.json
          git commit -m "New enrollment (pending)"
          git push

      - name: Send confirmation email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "Confirm your DOTS 6027 enrollment"
          to: ${{ fromJson(github.event.client_payload).email }}
          from: ${{ secrets.MAIL_FROM }}
          html_body: |
            <p>Thank you for enrolling in <strong>Derech Olam Training Services (6027)</strong>.</p>
            <p>Your enrollment status is currently <strong>pending</strong>.</p>
            <p>You will receive a confirmation link shortly.</p>
