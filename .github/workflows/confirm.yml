name: DOTS Email Confirmation

on:
  workflow_dispatch:
    inputs:
      token:
        required: true
        type: string

jobs:
  confirm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Confirm student by token
        run: |
          TOKEN="${{ github.event.inputs.token }}"

          MATCH=$(jq --arg token "$TOKEN" '
            map(select(.confirm_token == $token)) | length
          ' students.json)

          if [ "$MATCH" -eq 0 ]; then
            echo "âŒ Invalid or already confirmed token"
            exit 1
          fi

          jq --arg token "$TOKEN" '
            map(
              if .confirm_token == $token then
                .status = "confirmed"
                | del(.confirm_token)
              else .
              end
            )
          ' students.json > students.tmp

          mv students.tmp students.json

      - name: Commit confirmation update
        run: |
          git config user.name "DOTS Confirmation Bot"
          git config user.email "derech-olam-6027@outlook.com"
          git add students.json
          git commit -m "Enrollment confirmed"
          git push
