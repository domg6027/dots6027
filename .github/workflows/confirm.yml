name: DOTS Email Confirmation

on:
  workflow_dispatch:
    inputs:
      token:
        description: "Email confirmation token"
        required: true

jobs:
  confirm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Confirm enrollment
        run: |
          node <<'EOF'
          const fs = require('fs');

          const token = process.env.TOKEN;
          const data = JSON.parse(fs.readFileSync('students.json', 'utf8'));

          let updated = false;

          for (const student of data.students) {
            if (student.confirmation_token === token) {
              student.status = "active";
              student.email_verified = true;
              delete student.confirmation_token;
              updated = true;
              break;
            }
          }

          if (!updated) {
            console.error("Invalid or expired token");
            process.exit(1);
          }

          fs.writeFileSync('students.json', JSON.stringify(data, null, 2));
          EOF
        env:
          TOKEN: ${{ github.event.inputs.token }}

      - name: Commit confirmation
        run: |
          git config user.name "DOTS Confirmation Bot"
          git config user.email "bot@users.noreply.github.com"
          git add students.json
          git commit -m "Enrollment email confirmed"
          git push
